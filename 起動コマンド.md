# 起動コマンド（REST APIサーバ）

このドキュメントは、ACE-Step-1.5 の REST API サーバ（`acestep.api_server`）を用途別に起動するためのコマンド／スクリプトと、指定できる引数・環境変数をまとめたものです。

対象：
- REST APIサーバ（`/release_task` 等）

重要：
- APIサーバはメモリ内キュー／ジョブストアを使うため、**workers は 1 固定**が前提です。

## 0. どれを使うべき？（早見表）

- 手軽に前面起動（推奨）：`uv run acestep-api`
- `turbo` をデフォルトにしつつ、リクエスト単位で `base` へ切替：`./run_api_server_multimodel.sh`
- VRAMが厳しい（他アプリ常駐等）：`./run_api_server_lowvram.sh`
- バックグラウンド（nohup）で起動したい：`./run_api_server.sh`（既存）

## 1. オリジナル（公式）: `uv run acestep-api`（推奨）

### コマンド

```bash
uv run acestep-api
```

### 指定できる引数（`acestep-api` のCLI引数）

`acestep/api_server.py` の `main()` が受け取る引数です。

```text
--host      Bind host（既定: 環境変数 ACESTEP_API_HOST または 127.0.0.1）
--port      Bind port（既定: 環境変数 ACESTEP_API_PORT または 8001）
--api-key   APIキー（既定: 環境変数 ACESTEP_API_KEY）
```

例：

```bash
uv run acestep-api --host 0.0.0.0 --port 8001
uv run acestep-api --api-key sk-your-secret
```

### 便利な環境変数（例）

`acestep.api_server` はプロジェクト直下の `.env` を（python-dotenv が入っていれば）読みます。
そのため、シェル `export` の代わりに `.env` に書いてもOKです。

```env
ACESTEP_CONFIG_PATH=acestep-v15-turbo
ACESTEP_LM_MODEL_PATH=acestep-5Hz-lm-4B
ACESTEP_LM_BACKEND=vllm
ACESTEP_DEVICE=auto
```

## 2. オリジナル（手動）: `python -m uvicorn ...`

### コマンド

```bash
python -m uvicorn acestep.api_server:app --host 0.0.0.0 --port 8001 --workers 1
```

### 指定できる引数（代表例）

`uvicorn` の一般的な引数です（詳細は `python -m uvicorn --help` で確認）。

```text
--host        バインド先
--port        ポート
--log-level   debug/info/warning/error/critical
--workers     このAPIは 1 固定推奨（in-memoryキューのため）
```

## 3. 既存スクリプト: `./run_api_server.sh`（nohupでバックグラウンド）

### コマンド

```bash
./run_api_server.sh
```

### 備考

- `nohup` でバックグラウンド起動し、ログを `server.log` に出します。
- `ACESTEP_API_LOG_LEVEL` は反映されます。
- このスクリプト内の `uvicorn` 呼び出しは host/port が固定（`0.0.0.0:8001`）なので、host/port を柔軟に変えたい場合は「1」または「2」の方法が確実です。

## 4. マルチモデル（要件2）: `./run_api_server_multimodel.sh`

目的：
- **サーバのデフォルトは turbo のまま**
- **必要なリクエストだけ base に切り替える**

### コマンド

```bash
./run_api_server_multimodel.sh
```

### このスクリプトが使う主な環境変数（上書き可能）

- DiT（複数ロード）
  - `ACESTEP_CONFIG_PATH`（既定: `acestep-v15-turbo`）= primary（デフォルト）
  - `ACESTEP_CONFIG_PATH2`（既定: `acestep-v15-base`）= secondary（リクエストで選択可能）
  - `ACESTEP_CONFIG_PATH3`（既定: 空）= third（任意）

- LM（thinking/format/sample用）
  - `ACESTEP_LM_MODEL_PATH`（既定: `acestep-5Hz-lm-4B`）
  - `ACESTEP_LM_BACKEND`（既定: `vllm`）

- API
  - `ACESTEP_API_HOST`（既定: `0.0.0.0`）
  - `ACESTEP_API_PORT`（既定: `8001`）
  - `ACESTEP_API_LOG_LEVEL`（既定: `debug`）

例：

```bash
ACESTEP_API_PORT=8002 ./run_api_server_multimodel.sh
```

### リクエスト単位での切替（重要）

`/release_task` の JSON に `model` を含めます。

- turbo（デフォルト）：`model` を送らない
- base：`{"model": "acestep-v15-base", ...}`

重要：
- `model` は「サーバが同時ロードしているモデル名（ディレクトリ名）」に一致した場合だけ切り替わります。
- サーバが base をロードしていない状態では、`model=acestep-v15-base` を送っても primary（turbo）にフォールバックします。

## 5. 低VRAM（同時ロードが厳しい場合）: `./run_api_server_lowvram.sh`

目的：
- turbo+base の同時ロードをやめて、VRAMを節約する
- サーバ機能（thinking/format/sample）もできるだけ維持する

### コマンド

```bash
./run_api_server_lowvram.sh
```

### 指定できる環境変数（上書き例）

- DiT（単一）
  - `ACESTEP_CONFIG_PATH`（既定: `acestep-v15-turbo`）
  - base単一で起動したい場合：

```bash
ACESTEP_CONFIG_PATH=acestep-v15-base ./run_api_server_lowvram.sh
```

- LM（軽量デフォルト）
  - `ACESTEP_INIT_LLM=1`（LM初期化を強制）
  - `ACESTEP_LM_MODEL_PATH`（既定: `acestep-5Hz-lm-1.7B`）
  - 4Bに上げたい場合：

```bash
ACESTEP_LM_MODEL_PATH=acestep-5Hz-lm-4B ./run_api_server_lowvram.sh
```

- オフロード（VRAM節約）
  - `ACESTEP_OFFLOAD_TO_CPU`（既定: `1`）
  - `ACESTEP_LM_OFFLOAD_TO_CPU`（既定: `1`）
  - `ACESTEP_OFFLOAD_DIT_TO_CPU`（既定: `0`。遅くなるので通常は0）
